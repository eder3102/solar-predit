# 光伏发电预测系统设计文档

## 1. 系统目标
实现光伏发电预测系统，支持72小时滚动预测，预测粒度为15分钟。

## 2. 模型架构

### 2.1 整体架构
- 采用模型融合(Ensemble)方式，结合三种不同类型的模型：
  1. FilterNet: 基于自注意力机制的过滤器网络
  2. BiLSTM: 双向LSTM网络
  3. XGBoost: 梯度提升树模型
- 使用动态权重机制对三个模型的输出进行加权融合

### 2.2 各子模型特点

#### 2.2.1 FilterNet
- 使用多头自注意力机制处理时序依赖
- 包含多层FilterLayer，每层由以下组件构成：
  * 特征变换层
  * 多头自注意力层
  * Layer Normalization
  * 前馈网络
- 最后通过全连接层输出预测结果

#### 2.2.2 BiLSTM
- 使用双向LSTM捕获序列的长期依赖
- 包含时序注意力层
- 支持多层LSTM结构
- 通过全连接层输出预测结果

#### 2.2.3 XGBoost
- 处理高维特征的非线性关系
- 支持特征重要性评估
- 可以处理缺失值
- 输出被转换为与其他模型一致的格式

### 2.3 动态权重机制
- 使用DynamicWeightLayer动态计算三个模型的权重
- 权重计算过程：
  1. 输入特征经过全连接层变换
  2. 通过ReLU激活
  3. Dropout正则化
  4. 最后一层全连接输出权重
  5. Softmax归一化确保权重和为1

### 2.4 特征工程流水线

#### 2.4.1 特征处理器(FeatureProcessor)
- 添加时间特征(小时、日期、月份等)
- 添加天气特征(温度、湿度、辐射等)
- 添加功率特征(历史功率统计量)
- 支持标准化和最小最大缩放

#### 2.4.2 特征选择器(FeatureSelector)
- 支持多种特征选择方法(互信息、随机森林、XGBoost)
- 可以基于数量或阈值选择特征
- 保持特征顺序一致性

### 2.5 训练策略
- 采用分阶段训练：
  1. 先训练XGBoost模型
  2. 再训练神经网络模型(FilterNet和BiLSTM)
- 使用早停机制防止过拟合
- 支持动态调整学习率
- 使用MSE作为损失函数
- 支持批量训练和验证

### 2.6 预测流程
- 输入数据经过特征工程流水线处理
- 三个模型分别进行预测
- 通过动态权重层计算权重
- 加权融合得到最终预测结果
- 支持批量预测和单样本预测

### 2.7 模型配置
- 序列长度：96 (24小时，15分钟间隔)
- 预测长度：96 (24小时，15分钟间隔)
- 输入特征维度：91
- 隐藏层维度：64
- 支持CPU和GPU训练

## 3. 模型参数量统计

### 3.1 FilterNet参数量
```
# FilterLayer参数量
- 特征变换层: 
  * Linear(91 -> 64): 91 * 64 + 64 = 5,888
  
- 多头自注意力(4头):
  * Q/K/V变换: 3 * (64 * 64 + 64) = 12,480
  * 输出变换: 64 * 64 + 64 = 4,160
  
- 前馈网络:
  * Linear(64 -> 256): 64 * 256 + 256 = 16,640
  * Linear(256 -> 64): 256 * 64 + 64 = 16,448

每个FilterLayer总参数量: 55,616

# 2层FilterLayer: 55,616 * 2 = 111,232

# 输出层参数量:
- Linear(96*64 -> 64): 96 * 64 * 64 + 64 = 393,280
- Linear(64 -> 96): 64 * 96 + 96 = 6,240

FilterNet总参数量: 510,752
```

### 3.2 BiLSTM参数量
```
# BiLSTM层(2层):
- 输入门: 91 * 64 * 2 + 64 * 64 * 2 + 64 * 2 = 20,096
- 遗忘门: 91 * 64 * 2 + 64 * 64 * 2 + 64 * 2 = 20,096
- 单元状态: 91 * 64 * 2 + 64 * 64 * 2 + 64 * 2 = 20,096
- 输出门: 91 * 64 * 2 + 64 * 64 * 2 + 64 * 2 = 20,096

每层BiLSTM参数量: 80,384
2层BiLSTM总参数量: 160,768

# 输出层:
- Linear(128 -> 64): 128 * 64 + 64 = 8,256
- Linear(64 -> 96): 64 * 96 + 96 = 6,240

BiLSTM总参数量: 175,264
```

### 3.3 XGBoost参数量
```
# XGBoost参数量取决于树的数量和深度
- 树的数量: 100
- 最大深度: 6
- 每棵树最大叶子节点数: 2^6 = 64
- 每个叶子节点存储一个预测值

XGBoost近似参数量: 100 * 64 * (91 + 1) ≈ 588,800
```

### 3.4 动态权重层参数量
```
# 输入维度: 91 * 96 = 8,736
- Linear(8,736 -> 64): 8,736 * 64 + 64 = 559,168
- Linear(64 -> 3): 64 * 3 + 3 = 195

动态权重层总参数量: 559,363
```

### 3.5 总参数量汇总
1. FilterNet: 510,752 (27.8%)
2. BiLSTM: 175,264 (9.6%)
3. XGBoost: ~588,800 (32.1%)
4. 动态权重层: 559,363 (30.5%)

**模型总参数量: 1,834,179 ≈ 1.83M**

### 3.6 内存占用估算
- 假设使用float32类型(4字节)
- 模型参数占用内存: 1,834,179 * 4 ≈ 7.34MB
- 考虑优化器状态(如Adam)，实际运行时内存约为参数量的3-4倍
- 预计总内存占用: 22-30MB

### 3.7 优化建议
1. 动态权重层参数量占比较大，可以考虑减少中间层维度
2. FilterNet的输出层参数量较大，可以考虑增加一个维度降低层
3. BiLSTM参数量相对较小，可以适当增加容量
4. XGBoost可以通过调整树的数量和深度来平衡性能和参数量 